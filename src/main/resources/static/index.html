<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bible Search</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <style>
        :root { --bs-body-bg: #0d1117; --bs-body-color: #e6edf3; }
        body { min-height: 100vh; }
        .badge-method { font-size: 0.8rem; }
        .badge-keyword { background-color: rgba(63, 185, 80, 0.2); color: #3fb950; }
        .badge-semantic { background-color: rgba(88, 166, 255, 0.2); color: #58a6ff; }
        .badge-hybrid { background-color: rgba(163, 113, 247, 0.2); color: #a371f7; }
        .badge-context { background-color: rgba(210, 153, 34, 0.2); color: #d29922; }
        .badge-asv { background-color: rgba(88, 166, 255, 0.15); color: #58a6ff; }
        .badge-krv { background-color: rgba(163, 113, 247, 0.15); color: #a371f7; }
        .score-high { color: #3fb950; }
        .score-mid { color: #d29922; }
        .score-low { color: #8b949e; }
        .result-card { transition: transform 0.2s, border-color 0.2s; cursor: pointer; }
        .result-card:hover { transform: translateY(-2px); border-color: #d4a373 !important; }
        .verse-text { font-family: Georgia, serif; font-size: 1.1rem; line-height: 1.8; }
        .chip { cursor: pointer; transition: all 0.2s; }
        .chip:hover { background-color: #30363d !important; border-color: #d4a373 !important; color: #d4a373 !important; }
        .reader-verse.highlight { background-color: rgba(212, 163, 115, 0.15); border-left: 3px solid #d4a373; }
        .parallel-reader { display: grid; grid-template-columns: 1fr 1fr; gap: 0; }
        @media (max-width: 768px) { .parallel-reader { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container py-4">
        <!-- Header -->
        <header class="text-center mb-4">
            <h1 class="display-5 fw-bold"><i class="bi bi-book me-2"></i>Bible Search</h1>
            <p class="text-secondary mb-2">AI-powered search with automatic keyword, semantic & scoped detection</p>
            <a href="/help.html" class="text-decoration-none small">How does this work? <i class="bi bi-arrow-right"></i></a>
        </header>

        <!-- Search -->
        <div class="card bg-dark border-secondary mb-4">
            <div class="card-body">
                <form id="searchForm" class="row g-2">
                    <div class="col-12 col-md">
                        <div class="input-group">
                            <span class="input-group-text bg-secondary border-secondary"><i class="bi bi-search"></i></span>
                            <input type="text" class="form-control bg-dark border-secondary text-light" id="searchInput" 
                                   placeholder="사랑에 대한 말씀 / 사복음서에서 사랑 / John 3:16" autocomplete="off">
                        </div>
                    </div>
                    <div class="col-auto">
                        <button type="submit" class="btn btn-warning" id="searchBtn">Search</button>
                    </div>
                </form>
                <div class="row g-2 mt-2">
                    <div class="col-auto">
                        <select class="form-select form-select-sm bg-dark border-secondary text-light" id="versionFilter">
                            <option value="">All Versions</option>
                            <option value="ASV">ASV</option>
                            <option value="KRV">KRV</option>
                        </select>
                    </div>
                    <div class="col-auto">
                        <select class="form-select form-select-sm bg-dark border-secondary text-light" id="maxResults">
                            <option value="5">5 results</option>
                            <option value="10">10 results</option>
                            <option value="20">20 results</option>
                        </select>
                    </div>
                    <div class="col-auto">
                        <select class="form-select form-select-sm bg-dark border-secondary text-light" id="minScore">
                            <option value="0.2">Min 0.2</option>
                            <option value="0.3" selected>Min 0.3</option>
                            <option value="0.4">Min 0.4</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Area -->
        <div id="resultsArea">
            <div class="text-center py-5">
                <i class="bi bi-stars display-1 text-secondary opacity-50"></i>
                <h4 class="mt-3">Discover Scripture</h4>
                <p class="text-secondary">Search by keyword, meaning, or within specific books</p>
                
                <div class="mt-4">
                    <p class="text-muted small mb-2"><i class="bi bi-lightbulb me-1"></i> Semantic (by meaning)</p>
                    <div class="d-flex flex-wrap justify-content-center gap-2 mb-3">
                        <span class="chip badge bg-secondary border border-secondary" data-query="사랑에 대한 말씀">사랑에 대한 말씀</span>
                        <span class="chip badge bg-secondary border border-secondary" data-query="comfort in suffering">comfort in suffering</span>
                        <span class="chip badge bg-secondary border border-secondary" data-query="용서에 관한 구절">용서에 관한 구절</span>
                    </div>
                    
                    <p class="text-muted small mb-2"><i class="bi bi-fonts me-1"></i> Keyword (exact match)</p>
                    <div class="d-flex flex-wrap justify-content-center gap-2 mb-3">
                        <span class="chip badge bg-secondary border border-secondary" data-query="가사라는 지명이 나오는 구절">가사라는 지명</span>
                        <span class="chip badge bg-secondary border border-secondary" data-query="모세가 등장하는 구절">모세가 등장하는</span>
                        <span class="chip badge bg-secondary border border-secondary" data-query="verses containing shepherd">containing shepherd</span>
                    </div>
                    
                    <p class="text-muted small mb-2"><i class="bi bi-collection me-1"></i> Scoped (within books)</p>
                    <div class="d-flex flex-wrap justify-content-center gap-2">
                        <span class="chip badge bg-secondary border border-secondary" data-query="사복음서에서 사랑이 나온 구절">사복음서에서 사랑</span>
                        <span class="chip badge bg-secondary border border-secondary" data-query="로마서에서 복음의 정의">로마서에서 복음</span>
                        <span class="chip badge bg-secondary border border-secondary" data-query="바울서신에서 믿음에 관한">바울서신에서 믿음</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="text-center text-muted small mt-5 pt-4 border-top border-secondary">
            <a href="/help.html" class="text-decoration-none">Help & Examples</a><br>
            <span class="opacity-75">Zero latency · 100% local inference · LangChain4j + ONNX</span>
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const searchForm = document.getElementById('searchForm');
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const resultsArea = document.getElementById('resultsArea');
        const versionFilter = document.getElementById('versionFilter');
        const maxResults = document.getElementById('maxResults');
        const minScore = document.getElementById('minScore');

        let currentView = 'search';
        let lastSearchResults = null;
        let currentReaderState = null;

        // Book mappings
        const BOOK_MAP = {
            'genesis': { short: 'Gen', version: 'ASV' }, 'exodus': { short: 'Ex', version: 'ASV' },
            'john': { short: 'John', version: 'ASV' }, 'matthew': { short: 'Matt', version: 'ASV' },
            'mark': { short: 'Mark', version: 'ASV' }, 'luke': { short: 'Luke', version: 'ASV' },
            'romans': { short: 'Rom', version: 'ASV' }, 'psalms': { short: 'Ps', version: 'ASV' },
            'psalm': { short: 'Ps', version: 'ASV' }, 'ps': { short: 'Ps', version: 'ASV' },
            'gen': { short: 'Gen', version: 'ASV' }, 'ex': { short: 'Ex', version: 'ASV' },
            'jn': { short: 'John', version: 'ASV' }, 'matt': { short: 'Matt', version: 'ASV' },
            'rom': { short: 'Rom', version: 'ASV' }, 'rev': { short: 'Rev', version: 'ASV' },
            '1 cor': { short: '1 Cor', version: 'ASV' }, '1cor': { short: '1 Cor', version: 'ASV' },
            '창세기': { short: '창', version: 'KRV' }, '출애굽기': { short: '출', version: 'KRV' },
            '요한복음': { short: '요', version: 'KRV' }, '마태복음': { short: '마', version: 'KRV' },
            '로마서': { short: '롬', version: 'KRV' }, '시편': { short: '시', version: 'KRV' },
            '창': { short: '창', version: 'KRV' }, '출': { short: '출', version: 'KRV' },
            '요': { short: '요', version: 'KRV' }, '마': { short: '마', version: 'KRV' },
            '막': { short: '막', version: 'KRV' }, '눅': { short: '눅', version: 'KRV' },
            '롬': { short: '롬', version: 'KRV' }, '시': { short: '시', version: 'KRV' },
        };

        const ASV_TO_KRV = {
            'Gen': '창', 'Ex': '출', 'Ps': '시', 'Matt': '마', 'Mark': '막',
            'Luke': '눅', 'John': '요', 'Rom': '롬', 'Rev': '계', '1 Cor': '고전'
        };
        const KRV_TO_ASV = Object.fromEntries(Object.entries(ASV_TO_KRV).map(([k,v])=>[v,k]));

        function parseReference(input) {
            const refPattern = /^((?:\d\s*)?[a-zA-Z\u3131-\u318E\uAC00-\uD7A3]+(?:\s+[a-zA-Z\u3131-\u318E\uAC00-\uD7A3]+)*)\s*(\d+)(?:장|편)?(?:\s*[:\.]\s*(\d+)절?|\s*(\d+)절)?$/i;
            const match = input.trim().match(refPattern);
            if (!match) return null;
            let bookName = match[1].trim().toLowerCase().replace(/^(\d)\s*/, '$1 ').replace(/\s+/g, ' ').trim();
            let bookInfo = BOOK_MAP[bookName] || BOOK_MAP[bookName.replace(/\s+/g, '')];
            if (!bookInfo) return null;
            return { bookShort: bookInfo.short, version: bookInfo.version, chapter: parseInt(match[2]), verse: match[3] ? parseInt(match[3]) : (match[4] ? parseInt(match[4]) : null) };
        }

        function handleSearch() {
            const query = searchInput.value.trim();
            if (!query) return;
            const ref = parseReference(query);
            if (ref) openReader(ref.bookShort, ref.chapter, ref.verse, versionFilter.value || ref.version);
            else performSearch();
        }

        document.querySelectorAll('.chip').forEach(chip => {
            chip.addEventListener('click', () => { searchInput.value = chip.dataset.query; handleSearch(); });
        });

        searchForm.addEventListener('submit', e => { e.preventDefault(); handleSearch(); });

        async function performSearch() {
            currentView = 'search';
            searchBtn.disabled = true;
            resultsArea.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-warning"></div><p class="mt-3 text-secondary">Searching...</p></div>';

            try {
                const response = await fetch('/api/search', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: searchInput.value.trim(), maxResults: parseInt(maxResults.value), minScore: parseFloat(minScore.value), version: versionFilter.value || null })
                });
                const data = await response.json();
                lastSearchResults = data;
                renderResults(data);
            } catch (error) {
                resultsArea.innerHTML = `<div class="alert alert-danger"><i class="bi bi-exclamation-triangle me-2"></i>${error.message}</div>`;
            } finally { searchBtn.disabled = false; }
        }

        function renderResults(data) {
            if (!data.success) { resultsArea.innerHTML = `<div class="alert alert-danger">${data.error}</div>`; return; }
            if (!data.results?.length) { resultsArea.innerHTML = '<div class="text-center py-5 text-secondary"><i class="bi bi-search display-4"></i><p class="mt-3">No results found</p></div>'; return; }

            const methodIcon = data.searchMethod === 'KEYWORD' ? 'bi-fonts' : data.searchMethod === 'SEMANTIC' ? 'bi-lightbulb' : 'bi-arrow-repeat';
            const methodClass = data.searchMethod?.toLowerCase() || '';

            let html = `<div class="d-flex flex-wrap align-items-center gap-2 mb-3 small">
                <span class="text-secondary">Found <strong>${data.totalResults}</strong> in <strong>${data.searchTimeMs}ms</strong></span>
                ${data.searchMethod ? `<span class="badge badge-method badge-${methodClass}"><i class="bi ${methodIcon} me-1"></i>${data.searchMethod}${data.extractedKeyword ? ': "'+data.extractedKeyword+'"' : ''}</span>` : ''}
                ${data.detectedContext ? `<span class="badge badge-method badge-context"><i class="bi bi-collection me-1"></i>${data.detectedContext}</span>` : ''}
            </div><div class="d-flex flex-column gap-3">`;

            data.results.forEach(v => {
                const score = v.rerankedScore || v.score;
                const scoreClass = score >= 0.5 ? 'score-high' : score >= 0.35 ? 'score-mid' : 'score-low';
                const versionClass = v.version === 'ASV' ? 'badge-asv' : 'badge-krv';
                html += `<div class="card bg-dark border-secondary result-card" onclick="openReader('${v.bookShort}', ${v.chapter}, ${v.verse}, '${v.version}')">
                    <div class="card-header bg-secondary bg-opacity-25 d-flex justify-content-between align-items-start flex-wrap gap-2">
                        <div><strong class="text-warning">${v.reference}</strong>${v.title ? `<br><small class="text-muted fst-italic">${v.title}</small>` : ''}</div>
                        <div class="d-flex gap-2 align-items-center">
                            <span class="badge ${versionClass}">${v.version}</span>
                            <span class="${scoreClass} fw-bold">${Math.round(score*100)}%</span>
                        </div>
                    </div>
                    <div class="card-body"><p class="verse-text mb-0">${v.text}</p></div>
                </div>`;
            });
            html += '</div>';
            resultsArea.innerHTML = html;
        }

        async function openReader(bookShort, chapter, highlightVerse, version) {
            currentView = 'reader';
            resultsArea.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-warning"></div><p class="mt-3 text-secondary">Loading chapter...</p></div>';

            try {
                let asvBookShort = ASV_TO_KRV[bookShort] ? bookShort : KRV_TO_ASV[bookShort] || bookShort;
                let krvBookShort = KRV_TO_ASV[bookShort] ? bookShort : ASV_TO_KRV[bookShort] || bookShort;
                
                const [asvRes, krvRes] = await Promise.all([
                    fetch(`/api/bible/${encodeURIComponent(asvBookShort)}/${chapter}?version=ASV`),
                    fetch(`/api/bible/${encodeURIComponent(krvBookShort)}/${chapter}?version=KRV`)
                ]);

                let asvData = asvRes.ok ? await asvRes.json() : null;
                let krvData = krvRes.ok ? await krvRes.json() : null;

                if (!asvData && !krvData) throw new Error('Chapter not found');

                currentReaderState = { asvBookShort, krvBookShort, chapter, totalChapters: Math.max(asvData?.totalChapters || 0, krvData?.totalChapters || 0) };
                renderReader(asvData, krvData, highlightVerse);
            } catch (error) {
                resultsArea.innerHTML = `<div class="alert alert-danger">${error.message}<br><button class="btn btn-sm btn-outline-light mt-2" onclick="backToSearch()">Back</button></div>`;
            }
        }

        function renderReader(asvData, krvData, highlightVerse) {
            const primary = krvData || asvData;
            const chapter = primary.chapter;
            const { totalChapters } = currentReaderState;

            let chapterOpts = '';
            for (let i = 1; i <= totalChapters; i++) chapterOpts += `<option value="${i}" ${i === chapter ? 'selected' : ''}>${i}장</option>`;

            const maxVerses = Math.max(asvData?.verses?.length || 0, krvData?.verses?.length || 0);
            const asvMap = {}, krvMap = {};
            asvData?.verses?.forEach(v => asvMap[v.verse] = v);
            krvData?.verses?.forEach(v => krvMap[v.verse] = v);

            let krvHtml = '', asvHtml = '';
            for (let i = 1; i <= maxVerses; i++) {
                const hl = i === highlightVerse ? 'highlight' : '';
                krvHtml += `<div class="reader-verse py-2 px-2 border-bottom border-secondary ${hl}" id="krv-${i}"><span class="text-warning me-2 fw-bold">${i}</span><span class="verse-text">${krvMap[i]?.text || ''}</span></div>`;
                asvHtml += `<div class="reader-verse py-2 px-2 border-bottom border-secondary ${hl}" id="asv-${i}"><span class="text-warning me-2 fw-bold">${i}</span><span class="verse-text">${asvMap[i]?.text || ''}</span></div>`;
            }

            resultsArea.innerHTML = `
                <div class="card bg-dark border-secondary">
                    <div class="card-header bg-secondary bg-opacity-25 d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <div><button class="btn btn-sm btn-outline-secondary me-2" onclick="backToSearch()"><i class="bi bi-arrow-left"></i></button><strong class="text-warning">${primary.bookName} ${chapter}장</strong></div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-outline-secondary" onclick="navigateChapter(${chapter-1})" ${chapter <= 1 ? 'disabled' : ''}>Prev</button>
                            <select class="form-select form-select-sm bg-dark border-secondary text-light" style="width:auto" onchange="navigateChapter(parseInt(this.value))">${chapterOpts}</select>
                            <button class="btn btn-sm btn-outline-secondary" onclick="navigateChapter(${chapter+1})" ${chapter >= totalChapters ? 'disabled' : ''}>Next</button>
                        </div>
                    </div>
                    <div class="card-body p-0" style="max-height:70vh;overflow-y:auto;">
                        <div class="parallel-reader">
                            <div class="border-end border-secondary">
                                <div class="bg-secondary bg-opacity-25 p-2 text-center sticky-top"><span class="badge badge-krv">KRV</span></div>
                                <div class="p-2">${krvHtml}</div>
                            </div>
                            <div>
                                <div class="bg-secondary bg-opacity-25 p-2 text-center sticky-top"><span class="badge badge-asv">ASV</span></div>
                                <div class="p-2">${asvHtml}</div>
                            </div>
                        </div>
                    </div>
                </div>`;

            if (highlightVerse) setTimeout(() => document.getElementById(`krv-${highlightVerse}`)?.scrollIntoView({ behavior: 'smooth', block: 'center' }), 100);
        }

        function navigateChapter(ch) { if (currentReaderState) openReader(currentReaderState.asvBookShort, ch, null, 'ASV'); }

        function backToSearch() {
            currentView = 'search';
            if (lastSearchResults) renderResults(lastSearchResults);
            else location.reload();
        }

        // URL query param
        const urlQ = new URLSearchParams(window.location.search).get('q');
        if (urlQ) { searchInput.value = urlQ; history.replaceState({}, '', location.pathname); setTimeout(handleSearch, 100); }
        else searchInput.focus();
    </script>
</body>
</html>
